name: Deploy to Proxmox

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    name: Deploy to Production
    runs-on: self-hosted  # Runs on your Proxmox LXC
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to app container via SSH
        env:
          APP_CONTAINER_IP: ${{ secrets.APP_CONTAINER_IP }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
        run: |
          # Setup SSH key
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Deploy via SSH
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${DEPLOY_USER}@$APP_CONTAINER_IP << 'ENDSSH'
            set -e
            cd /opt/johnai-predictions
            
            echo "ðŸ”„ Pulling latest changes..."
            git pull origin main
            
            echo "ðŸ‹ Rebuilding and restarting containers..."
            docker compose --profile tunnel down
            docker compose --profile tunnel up -d --build
            
            echo "â³ Waiting for services to start..."
            sleep 10
            
            echo "âœ… Checking container status..."
            docker compose ps
            
            echo "ðŸŽ‰ Deployment completed successfully!"
          ENDSSH
          
          # Cleanup
          rm -f ~/.ssh/deploy_key

      - name: Verify deployment
        env:
          APP_CONTAINER_IP: ${{ secrets.APP_CONTAINER_IP }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
        run: |
          # Setup SSH key
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Verify via SSH
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${DEPLOY_USER}@$APP_CONTAINER_IP << 'ENDSSH'
            cd /opt/johnai-predictions
            
            # Check if main container is running
            if docker compose ps | grep -q "johnai-predictions.*Up"; then
              echo "âœ… Application container is running"
            else
              echo "âŒ Application container is not running"
              exit 1
            fi
            
            # Check if Cloudflare tunnel is connected
            if docker compose ps | grep -q "cloudflared.*Up"; then
              echo "âœ… Cloudflare tunnel is connected"
            else
              echo "âŒ Cloudflare tunnel is not connected"
              exit 1
            fi
          ENDSSH
          
          # Cleanup
          rm -f ~/.ssh/deploy_key

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "âœ… Deployment successful!"
          else
            echo "âŒ Deployment failed!"
          fi
