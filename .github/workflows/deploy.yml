name: Deploy to Proxmox

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    name: Deploy to Production
    runs-on: self-hosted  # Runs on your Proxmox LXC
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to app container via SSH
        env:
          APP_CONTAINER_IP: ${{ secrets.APP_CONTAINER_IP }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          CLOUDFLARE_TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          VITE_ADMIN_PASSWORD: ${{ secrets.VITE_ADMIN_PASSWORD }}
        run: |
          # Setup SSH key
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Create .env content locally
          cat > /tmp/deploy_env << EOF
VITE_SUPABASE_PROJECT_ID="local"
VITE_SUPABASE_PUBLISHABLE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0"
VITE_SUPABASE_URL="https://predictions.johnfoster.cloud/api"
POSTGRES_HOST="localhost"
POSTGRES_PORT="5432"
POSTGRES_DB="postgres"
POSTGRES_USER="postgres"
POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
CLOUDFLARE_TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
VITE_ADMIN_PASSWORD=${VITE_ADMIN_PASSWORD}
EOF
          
          # Copy .env file to remote
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no /tmp/deploy_env ${DEPLOY_USER}@$APP_CONTAINER_IP:/tmp/.env
          
          # Deploy via SSH
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${DEPLOY_USER}@$APP_CONTAINER_IP << 'ENDSSH'
            set -e
            cd /opt/johnai-predictions
            
            echo "ðŸ”„ Pulling latest changes..."
            git pull origin main
            
            echo "ðŸ” Moving .env file into place..."
            sudo mv /tmp/.env .env
            sudo chown predictions:predictions .env
            chmod 600 .env
            
            echo "ðŸ—„ï¸ Applying database migrations..."
            for migration in supabase/migrations/*.sql; do
              if [ -f "$migration" ]; then
                echo "Applying $(basename $migration)..."
                docker exec -i johnai-postgres psql -U postgres -d postgres < "$migration" || echo "Migration $(basename $migration) failed or already applied"
              fi
            done
            
            echo "ðŸ‹ Rebuilding and restarting containers..."
            docker compose --profile tunnel down
            docker compose --profile tunnel up -d --build
            
            echo "â³ Waiting for services to start..."
            sleep 10
            
            echo "âœ… Checking container status..."
            docker compose ps
            
            echo "ðŸŽ‰ Deployment completed successfully!"
          ENDSSH
          
          # Cleanup
          rm -f ~/.ssh/deploy_key

      - name: Verify deployment
        env:
          APP_CONTAINER_IP: ${{ secrets.APP_CONTAINER_IP }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
        run: |
          # Setup SSH key
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Verify via SSH
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${DEPLOY_USER}@$APP_CONTAINER_IP << 'ENDSSH'
            cd /opt/johnai-predictions
            
            # Check if main container is running
            if docker compose ps | grep -q "johnai-predictions.*Up"; then
              echo "âœ… Application container is running"
            else
              echo "âŒ Application container is not running"
              exit 1
            fi
            
            # Check if Cloudflare tunnel is connected
            if docker compose ps | grep -q "cloudflared.*Up"; then
              echo "âœ… Cloudflare tunnel is connected"
            else
              echo "âŒ Cloudflare tunnel is not connected"
              exit 1
            fi
          ENDSSH
          
          # Cleanup
          rm -f ~/.ssh/deploy_key

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "âœ… Deployment successful!"
          else
            echo "âŒ Deployment failed!"
          fi
